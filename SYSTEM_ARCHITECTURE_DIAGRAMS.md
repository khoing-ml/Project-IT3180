# Bill Setup Feature - Visual Overview

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ADMIN INTERFACE                              â”‚
â”‚              /admin/bills-setup (React Page)                    â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Configuration Form                                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Period Selector (YYYY-MM)                            â”‚ â”‚
â”‚  â”‚  â”œâ”€ Service Manager                                       â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Service Name Input                                â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Unit Cost Input                                  â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Quantity Input                                   â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Unit Type Input                                  â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Add Service Button                               â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ Remove Service Button (Ã—)                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Total Amount Display (Auto-calculated)              â”‚ â”‚
â”‚  â”‚  â”œâ”€ Create New Button                                   â”‚ â”‚
â”‚  â”‚  â””â”€ Status Indicator                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Configuration List                                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ [DRAFT] Periode 2025-01                              â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Services: 3 items                                â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Total: 800,000Ä‘                                 â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ [Edit] [Publish & Notify] [Delete]              â”‚ â”‚
â”‚  â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ [ACTIVE] Periode 2024-12                            â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Services: 3 items                                â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Total: 750,000Ä‘                                 â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ âœ“ Notifications Sent                             â”‚ â”‚
â”‚  â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  â””â”€ [COMPLETED] Periode 2024-11                         â”‚ â”‚
â”‚  â”‚     â””â”€ Services: 3 items                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         â–¼                    â–¼                    â–¼
    [Create]            [Update]            [Delete]
         â”‚                    â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  API GATEWAY    â”‚
                    â”‚  (Auth checks)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚                   â”‚
         â–¼                   â–¼                   â–¼
   [POST /setup]     [POST /publish]     [PATCH/DELETE]
         â”‚                   â”‚                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  CONTROLLERS    â”‚
                    â”‚  Validation &   â”‚
                    â”‚  Business Logic â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚
                    â–¼                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Database    â”‚    â”‚ Notification     â”‚
            â”‚               â”‚    â”‚ Service          â”‚
            â”‚ bill_configs  â”‚    â”‚                  â”‚
            â”‚               â”‚    â”‚ notifyAllClients â”‚
            â”‚ â”œâ”€ id         â”‚    â”‚                  â”‚
            â”‚ â”œâ”€ period     â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
            â”‚ â”œâ”€ services   â”‚    â”‚ â”‚ Get all      â”‚ â”‚
            â”‚ â”œâ”€ status     â”‚    â”‚ â”‚ users with   â”‚ â”‚
            â”‚ â”œâ”€ created_by â”‚    â”‚ â”‚ role='user'  â”‚ â”‚
            â”‚ â”œâ”€ created_at â”‚    â”‚ â”‚              â”‚ â”‚
            â”‚ â””â”€ published_ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
            â”‚   at          â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
            â”‚               â”‚    â”‚ â”‚ Create bulk  â”‚ â”‚
            â”‚ RLS Policies  â”‚    â”‚ â”‚ notificationsâ”‚ â”‚
            â”‚ â”œâ”€ Admins OK  â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
            â”‚ â”œâ”€ Users See  â”‚    â”‚                  â”‚
            â”‚ â”‚  Active     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ â”‚  Only       â”‚              â”‚
            â”‚ â””â”€ Read-only  â”‚              â–¼
            â”‚   for status  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   check       â”‚    â”‚ Notification     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ Table            â”‚
                                 â”‚                  â”‚
                                 â”‚ â”œâ”€ user_id      â”‚
                                 â”‚ â”œâ”€ type          â”‚
                                 â”‚ â”œâ”€ title         â”‚
                                 â”‚ â”œâ”€ message       â”‚
                                 â”‚ â”œâ”€ link          â”‚
                                 â”‚ â”œâ”€ metadata      â”‚
                                 â”‚ â”œâ”€ created_at   â”‚
                                 â”‚ â”œâ”€ read          â”‚
                                 â”‚ â””â”€ id            â”‚
                                 â”‚                  â”‚
                                 â”‚ Multiple records â”‚
                                 â”‚ (one per client) â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  SUPABASE REALTIME      â”‚
                          â”‚  Broadcast Updates to   â”‚
                          â”‚  Subscribed Clients     â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  FRONTEND CONTEXT       â”‚
                          â”‚  NotificationContext    â”‚
                          â”‚  Updates notifications  â”‚
                          â”‚  & unread count         â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  CLIENT UI              â”‚
                          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                          â”‚  â”‚ Bell Icon (5)     â”‚ â”‚
                          â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                          â”‚         â”‚            â”‚
                          â”‚         â–¼            â”‚
                          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                          â”‚  â”‚Notification   â”‚  â”‚
                          â”‚  â”‚Panel          â”‚  â”‚
                          â”‚  â”œâ”€ Title        â”‚  â”‚
                          â”‚  â”œâ”€ Message      â”‚  â”‚
                          â”‚  â”œâ”€ Services     â”‚  â”‚
                          â”‚  â”œâ”€ Total: 800K  â”‚  â”‚
                          â”‚  â”œâ”€ [Pay Now]    â”‚  â”‚
                          â”‚  â”œâ”€ [Read]       â”‚  â”‚
                          â”‚  â””â”€ [Delete]     â”‚  â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow - Create and Publish

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Admin clicks â”‚
â”‚ "Táº¡o má»›i"    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fills form:         â”‚
â”‚ - Period: 2025-01   â”‚
â”‚ - Services:         â”‚
â”‚   â€¢ Äiá»‡n            â”‚
â”‚   â€¢ NÆ°á»›c            â”‚
â”‚   â€¢ Vá»‡ sinh         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend validates: â”‚
â”‚ âœ“ Has period?       â”‚
â”‚ âœ“ Has services?     â”‚
â”‚ âœ“ Services valid?   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ POST /api/bills/setup
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend:                 â”‚
â”‚ 1. Verify auth token     â”‚
â”‚ 2. Check role=admin|mgr  â”‚
â”‚ 3. Validate inputs       â”‚
â”‚ 4. Insert to DB          â”‚
â”‚ 5. Return config ID      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Configuration Created:      â”‚
â”‚ â”œâ”€ ID: uuid                 â”‚
â”‚ â”œâ”€ Period: 2025-01          â”‚
â”‚ â”œâ”€ Services: [...]          â”‚
â”‚ â”œâ”€ Status: DRAFT            â”‚
â”‚ â”œâ”€ Created: 2025-01-15      â”‚
â”‚ â””â”€ Created by: Admin1       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Admin clicks                 â”‚
â”‚ "CÃ´ng bá»‘ & ThÃ´ng bÃ¡o"        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ POST /api/bills/publish
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend publishBillConfig():  â”‚
â”‚ 1. Verify auth               â”‚
â”‚ 2. Check role=admin|mgr      â”‚
â”‚ 3. Get config by ID          â”‚
â”‚ 4. Verify status=DRAFT       â”‚
â”‚ 5. Update statusâ†’ACTIVE      â”‚
â”‚ 6. Set published_at          â”‚
â”‚ 7. Calculate total amount    â”‚
â”‚ 8. Call notifyAllClients()   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                 â”‚
       â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get all users    â”‚          â”‚ Calculate total:   â”‚
â”‚ with role='user' â”‚          â”‚ 3500*100 = 350K    â”‚
â”‚                  â”‚          â”‚ 8000*50  = 400K    â”‚
â”‚ 10 clients found â”‚          â”‚ 50000*1  = 50K     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
         â”‚                    â”‚ Total = 800K       â”‚
         â–¼                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    Create 10 notifications      â”‚
    in notifications table       â”‚
    - User 1 â†’ warning          â”‚
    - User 2 â†’ warning          â”‚
    - ...                       â”‚
    - User 10 â†’ warning         â”‚
         â”‚                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Supabase Realtime   â”‚
         â”‚ Broadcasts new      â”‚
         â”‚ notifications to    â”‚
         â”‚ all connected       â”‚
         â”‚ clients             â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           â”‚           â”‚
    â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”
â”‚User1â”‚     â”‚User2â”‚ ... â”‚User10â”‚
â”‚ ğŸ””1 â”‚     â”‚ ğŸ””1 â”‚     â”‚ ğŸ””1  â”‚
â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜
    â”‚           â”‚           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Admin sees success  â”‚
      â”‚ message:            â”‚
      â”‚ "Configuration      â”‚
      â”‚  published and all  â”‚
      â”‚  clients notified"  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Service Structure Example

```
Service Object:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {                                    â”‚
â”‚   name: "Äiá»‡n",       â† Service type â”‚
â”‚   unit_cost: 3500,    â† Cost per     â”‚
â”‚   number_of_units: 100, â† Quantity   â”‚
â”‚   unit: "kWh"         â† Unit type    â”‚
â”‚ }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Calculation:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3500 (cost) Ã— 100 (qty) = 350,000Ä‘  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Full Configuration:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Period: 2025-01                                         â”‚
â”‚                                                         â”‚
â”‚ Services:                                               â”‚
â”‚ â”œâ”€ Äiá»‡n: 3,500Ä‘/kWh Ã— 100 kWh = 350,000Ä‘             â”‚
â”‚ â”œâ”€ NÆ°á»›c: 8,000Ä‘/mÂ³ Ã— 50 mÂ³ = 400,000Ä‘                â”‚
â”‚ â””â”€ Vá»‡ sinh: 50,000Ä‘/cÄƒn Ã— 1 cÄƒn = 50,000Ä‘            â”‚
â”‚                                                         â”‚
â”‚ TOTAL: 800,000Ä‘                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Configuration States & Transitions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  START   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DRAFT (NhÃ¡p)                               â”‚
â”‚                                            â”‚
â”‚ Operations allowed:                        â”‚
â”‚ - View âœ“                                   â”‚
â”‚ - Edit âœ“                                   â”‚
â”‚ - Update services âœ“                        â”‚
â”‚ - Delete âœ“                                 â”‚
â”‚ - Publish âœ“                                â”‚
â”‚                                            â”‚
â”‚ Notifications sent: NO                     â”‚
â”‚ Editable: YES                              â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ (Click "CÃ´ng bá»‘ & ThÃ´ng bÃ¡o")
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ACTIVE (ÄÃ£ cÃ´ng bá»‘)                        â”‚
â”‚                                            â”‚
â”‚ Operations allowed:                        â”‚
â”‚ - View âœ“                                   â”‚
â”‚ - Edit âœ—                                   â”‚
â”‚ - Update âœ—                                 â”‚
â”‚ - Delete âœ—                                 â”‚
â”‚ - Publish âœ—                                â”‚
â”‚                                            â”‚
â”‚ Notifications sent: YES (to all clients)   â”‚
â”‚ Editable: NO                               â”‚
â”‚ Status message: "âœ“ Notifications sent"     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ (After billing period ends)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COMPLETED (HoÃ n thÃ nh)                     â”‚
â”‚                                            â”‚
â”‚ Operations allowed:                        â”‚
â”‚ - View âœ“                                   â”‚
â”‚ - Edit âœ—                                   â”‚
â”‚ - Update âœ—                                 â”‚
â”‚ - Delete âœ—                                 â”‚
â”‚ - Publish âœ—                                â”‚
â”‚                                            â”‚
â”‚ Purpose: Archive/Reference                 â”‚
â”‚ Editable: NO                               â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
    ARCHIVED
```

## Request/Response Flow - Example

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND REQUEST                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /api/bills/publish                                     â”‚
â”‚ Headers:                                                    â”‚
â”‚   Authorization: Bearer eyJhbGc...                          â”‚
â”‚   Content-Type: application/json                           â”‚
â”‚                                                             â”‚
â”‚ Body:                                                       â”‚
â”‚ {                                                           â”‚
â”‚   "configId": "550e8400-e29b-41d4-a716-446655440000"      â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND PROCESSING                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Verify JWT token                                        â”‚
â”‚    â””â”€ Valid âœ“                                              â”‚
â”‚ 2. Check user role                                         â”‚
â”‚    â””â”€ Is admin/manager âœ“                                   â”‚
â”‚ 3. Get configuration                                        â”‚
â”‚    â””â”€ Found & status=draft âœ“                               â”‚
â”‚ 4. Update status to active                                 â”‚
â”‚    â””â”€ Updated âœ“                                            â”‚
â”‚ 5. Get all users with role='user'                          â”‚
â”‚    â””â”€ Found 10 users âœ“                                     â”‚
â”‚ 6. Create 10 notifications                                 â”‚
â”‚    â””â”€ All inserted âœ“                                       â”‚
â”‚ 7. Return success response                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND RESPONSE (200 OK)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                           â”‚
â”‚   "message": "Configuration published and all clients       â”‚
â”‚               notified",                                    â”‚
â”‚   "data": {                                                 â”‚
â”‚     "id": "550e8400-e29b-41d4-a716-446655440000",         â”‚
â”‚     "period": "2025-01",                                   â”‚
â”‚     "status": "active",                                    â”‚
â”‚     "published_at": "2025-01-15T10:31:00Z",               â”‚
â”‚     "services": [                                          â”‚
â”‚       {                                                     â”‚
â”‚         "name": "Äiá»‡n",                                    â”‚
â”‚         "unit_cost": 3500,                                 â”‚
â”‚         "number_of_units": 100,                            â”‚
â”‚         "unit": "kWh"                                      â”‚
â”‚       },                                                    â”‚
â”‚       ...                                                   â”‚
â”‚     ]                                                       â”‚
â”‚   },                                                        â”‚
â”‚   "totalAmount": 800000,                                   â”‚
â”‚   "clientsNotified": true                                  â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND HANDLING                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Show success message                                    â”‚
â”‚    "CÃ´ng bá»‘ cáº¥u hÃ¬nh vÃ  thÃ´ng bÃ¡o cho táº¥t cáº£ khÃ¡ch        â”‚
â”‚     hÃ ng thÃ nh cÃ´ng"                                       â”‚
â”‚ 2. Update UI                                               â”‚
â”‚    - Change status badge to "ÄÃ£ cÃ´ng bá»‘"                   â”‚
â”‚    - Disable edit/delete buttons                           â”‚
â”‚    - Show "âœ“ ÄÃ£ gá»­i thÃ´ng bÃ¡o" message                     â”‚
â”‚ 3. Reload configurations list                              â”‚
â”‚    - Show updated config in list                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Access Control Matrix

```
                    â”‚ CREATE â”‚ READ â”‚ UPDATE â”‚ DELETE â”‚ PUBLISH â”‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
ADMIN               â”‚   âœ“    â”‚  âœ“   â”‚   âœ“    â”‚   âœ“    â”‚    âœ“    â”‚
MANAGER             â”‚   âœ“    â”‚  âœ“   â”‚   âœ“    â”‚   âœ“    â”‚    âœ“    â”‚
USER (Resident)     â”‚   âœ—    â”‚  âœ“   â”‚   âœ—    â”‚   âœ—    â”‚    âœ—    â”‚
ANONYMOUS           â”‚   âœ—    â”‚  âœ—   â”‚   âœ—    â”‚   âœ—    â”‚    âœ—    â”‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Notes:
- CREATE: Admin/Manager can create new configurations
- READ: All authenticated users can view active configs
- UPDATE: Only Admin/Manager can edit draft configs
- DELETE: Only Admin/Manager can delete draft configs
- PUBLISH: Only Admin/Manager can publish configs

RLS Enforcement:
âœ“ Database-level policies
âœ“ API middleware checks
âœ“ Frontend permission checks
```

## Notification Timeline

```
Timeline for Single Client:

09:30 AM
â”‚
â”œâ”€ Admin creates configuration
â”‚  â””â”€ Status: DRAFT
â”‚     Users see: Nothing
â”‚
â”œâ”€ Admin edits configuration
â”‚  â””â”€ Status: DRAFT
â”‚     Users see: Nothing
â”‚
â”‚  (30 minutes pass)
â”‚
â”‚ 10:00 AM
â”‚
â”œâ”€ Admin publishes configuration
â”‚  â””â”€ Status: ACTIVE
â”‚
â”œâ”€ Backend: notifyAllClients() called
â”‚  â”œâ”€ Get all users: Found 10
â”‚  â””â”€ Create notifications: 10 inserted
â”‚
â”œâ”€ Supabase Realtime broadcasts
â”‚  â””â”€ Sends to subscribed clients
â”‚
â”‚  (< 1 second passes)
â”‚
â”œâ”€ Client browser receives notification
â”‚  â”œâ”€ Unread count: 0 â†’ 1
â”‚  â”œâ”€ Bell icon shows: (1)
â”‚  â””â”€ Notification appears in panel
â”‚
â”œâ”€ Client reads notification
â”‚  â””â”€ Title: "Cáº¥u hÃ¬nh hÃ³a Ä‘Æ¡n thÃ¡ng 2025-01"
â”‚  â””â”€ Message: "Vui lÃ²ng thanh toÃ¡n hÃ³a Ä‘Æ¡n..."
â”‚  â””â”€ Shows: "Äiá»‡n: 3.500Ä‘ Ã— 100 = 350.000Ä‘"
â”‚  â””â”€ Shows: "Total: 800.000Ä‘"
â”‚  â””â”€ Button: [Thanh toÃ¡n]
â”‚
â””â”€ End result:
   âœ“ Client knows about bill
   âœ“ Client sees amount
   âœ“ Client can pay immediately
```

---

**Visual Overview Complete**
All diagrams show the complete system flow and architecture.
